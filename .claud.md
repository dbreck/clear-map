# Clear Map WordPress Plugin - Context for Next Session

## Project Overview
**Clear Map** is a WordPress plugin for interactive maps with POI (Point of Interest) filtering and category management. It uses Mapbox GL JS for map rendering and supports KML/KMZ imports with automatic geocoding via Mapbox Geocoding API (with Google as optional fallback).

**GitHub Repo (upcoming)**: This plugin will be pushed to GitHub for reuse across multiple client sites.

**Plugin Location**: `/wp-content/plugins/clear-map/`

---

## Recent Session Summary

### What Was Accomplished
1. **Renamed plugin** from "The Andrea Map" to "Clear Map" for reusability across client sites
2. **Implemented Mapbox Geocoding API** as the primary geocoding provider (replacing Google to avoid billing concerns)
3. **Added reverse geocoding functionality** - POIs imported from KML with coordinates but no addresses now automatically get addresses via Mapbox reverse geocoding
4. **Fixed KML import issue** - Coordinates are now properly extracted and saved during import
5. **Added manual geocoding button** in plugin settings with visual feedback (spinner, status messages, 20-second refresh delay)
6. **Extended timeout** for geocoding success message from 2 to 20 seconds
7. **Fixed tooltip CSS** - Updated tooltip styling with white background, borders, and shadows (though user reported it hasn't applied yet - needs investigation)

### Current Status
- **KML Import**: âœ… Working - extracts coordinates and reverse geocodes to get addresses
- **Manual Geocoding Button**: âœ… Working - reverse geocodes POIs with coordinates but no addresses
- **Map Display**: âœ… Working - displays POIs with proper coordinates
- **Tooltip Styling**: âš ï¸ Needs attention - CSS updated but user reports no visual change

---

## Plugin Architecture

### Core Files
- **`clear-map.php`** - Main plugin file, AJAX handlers, initialization
- **`includes/class-admin.php`** - WordPress admin interface and settings pages
- **`includes/class-frontend.php`** - Frontend shortcode registration
- **`includes/class-map-renderer.php`** - Renders map HTML and enqueues assets
- **`includes/class-api-handler.php`** - Handles geocoding (forward & reverse) via Mapbox/Google APIs
- **`includes/class-kml-parser.php`** - Parses KML/KMZ files and extracts POIs with coordinates
- **`includes/class-assets.php`** - Asset management

### Frontend Assets
- **`assets/js/map.js`** - Map initialization, POI rendering, clustering, filters (class: `ClearMap`)
- **`assets/css/map.css`** - Map and UI styles
- **`assets/js/admin.js`** - Admin page JavaScript (AJAX handlers, UI interactions)
- **`assets/css/admin.css`** - Admin page styles

### Key Features
- **KML/KMZ Import** - Imports POIs from Google My Maps exports
- **Auto-categorization** - Detects categories from KML folder structure
- **Forward Geocoding** - Converts addresses â†’ coordinates (Mapbox primary, Google fallback)
- **Reverse Geocoding** - Converts coordinates â†’ addresses (Mapbox primary, Google fallback)
- **Manual Geocoding Button** - Runs reverse geocoding on demand
- **Interactive Map** - Mapbox GL JS with clustering, category filtering, POI tooltips
- **Shortcodes** - `[clear_map]` and `[the_andrea_map]` (backwards compatibility)

---

## Data Structure

### POI Structure (stored in `clear_map_pois` option)
```php
array(
    'category_key' => array(
        array(
            'name' => 'POI Name',
            'address' => '123 Street, City, State ZIP',
            'description' => 'Description text',
            'website' => 'https://example.com',
            'photo' => 'https://example.com/photo.jpg',
            'lat' => 40.7479925,
            'lng' => -74.0047649,
            'coordinate_source' => 'kml|geocoded|reverse_geocoded',
            'reverse_geocoded' => true|false,
            'needs_geocoding' => true|false
        )
    )
)
```

### Categories Structure (stored in `clear_map_categories` option)
```php
array(
    'category_key' => array(
        'name' => 'Display Name',
        'color' => '#HEX'
    )
)
```

---

## Known Issues & Next Steps

### ðŸ”´ Tooltip Styling Issue
**Problem**: User reports tooltips have no background/boundaries despite CSS being updated
**Location**: `/assets/css/map.css` lines 198-226
**What was changed**: Updated from dark transparent background to white with borders/shadows
**Action needed**: Investigate why CSS isn't applying - check if file is being cached, minified, or not enqueued properly

### ðŸ“‹ UI/UX Updates Needed (User's Next Task)
The user wants to make **admin UI/UX updates** before pushing to GitHub. Specific updates not yet defined but likely include:
- Admin page layout/design improvements
- Settings page organization
- Import workflow UX
- Dashboard stats display
- Activity log presentation

---

## API Configuration

### Required API Keys
- **Mapbox Access Token** - Required for map rendering and geocoding
- **Google Geocoding API Key** - Optional fallback for geocoding

### API Usage
- **Mapbox Geocoding**: 100,000 free requests/month
- **Mapbox Maps**: 50,000 free loads/month
- **Google Geocoding**: User disabled billing to avoid unexpected charges

---

## Geocoding Flow

### Forward Geocoding (Address â†’ Coordinates)
1. User has POI with address but no coordinates
2. `Clear_Map_API_Handler::geocode_pois()` called
3. Tries Mapbox first, falls back to Google
4. Coordinates saved to POI with `coordinate_source: 'geocoded'`

### Reverse Geocoding (Coordinates â†’ Address)
1. User imports KML with coordinates but no addresses
2. `Clear_Map_API_Handler::reverse_geocode_pois()` called automatically during import
3. OR user clicks "Run Geocoding on All POIs" button manually
4. Tries Mapbox first, falls back to Google
5. Address saved to POI with `reverse_geocoded: true`

---

## Important Code Sections

### KML Import Process
**File**: `clear-map.php` lines 144-320
**Function**: `save_imported_pois()`
**Key Logic**: Detects if POIs need forward or reverse geocoding, runs appropriate method

### Manual Geocoding Button Handler
**File**: `clear-map.php` lines 423-463
**Function**: `run_manual_geocoding()`
**Does**: Reverse geocodes all POIs with coordinates but no addresses

### Map Tooltip Display
**File**: `assets/js/map.js` lines 430-454
**Function**: `showPoiTooltip(e)` and `hidePoiTooltip()`
**CSS**: `assets/css/map.css` lines 198-226 (class: `.clear-map-tooltip`)

### Reverse Geocoding Implementation
**File**: `includes/class-api-handler.php` lines 235-368
**Functions**:
- `reverse_geocode_pois()` - Main method for batch reverse geocoding
- `reverse_geocode()` - Routes to Mapbox or Google
- `reverse_geocode_mapbox()` - Mapbox reverse geocoding API
- `reverse_geocode_google()` - Google reverse geocoding API

---

## Testing Data

### Test KML File
**Location**: `/wp-content/plugins/clear-map/280 8th Avenue Neighborhood.kml`
**Contains**: 95 POIs across 6 categories (Parks, Schools, Transportation, Museums & Entertainment, Grocery & Shopping, Bars/Cafes & Dining)
**Structure**: Google My Maps export with KML folders containing placemarks with coordinates

### Test Scripts (for debugging)
- `/check-pois.php` - View POI data structure
- `/check-single-poi.php` - View first POI complete data
- `/test-kml-parse.php` - Test KML parser with debug log

---

## Plugin Settings

### Settings Location
WordPress Admin â†’ Clear Map â†’ Settings

### Available Settings
- Mapbox Access Token (required)
- Google Geocoding API Key (optional)
- Building Icon Width
- Cluster Distance
- Cluster Min Points
- Zoom Threshold
- Show Subway Lines (toggle)
- Building Address
- Building Icon (SVG/PNG upload)

### Manual Geocoding Section
Located in Settings page with button: "Run Geocoding on All POIs"
**Purpose**: Reverse geocode POIs that have coordinates but no addresses
**Feedback**: Spinner, status messages, detailed statistics, 20-second refresh delay

---

## WordPress Integration

### Shortcodes
- `[clear_map]` - Primary shortcode
- `[the_andrea_map]` - Backwards compatibility (from previous plugin name)

### Options Stored in Database
- `clear_map_pois` - All POI data
- `clear_map_categories` - Category definitions
- `clear_map_mapbox_token` - Mapbox access token
- `clear_map_google_api_key` - Google API key
- `clear_map_building_icon_width` - Icon width setting
- `clear_map_cluster_distance` - Clustering distance
- `clear_map_cluster_min_points` - Min POIs for cluster
- `clear_map_zoom_threshold` - Zoom level threshold
- `clear_map_show_subway_lines` - Subway layer toggle
- `clear_map_activity` - Activity log (last 20 actions)

### AJAX Actions
- `clear_map_import_kml_pois` - Handle KML file upload
- `clear_map_save_imported_pois` - Save imported POIs to database
- `clear_map_run_geocoding` - Manual reverse geocoding button
- `clear_map_geocode_cache` - Clear geocoding cache
- `clear_map_clear_all_pois` - Clear all POIs and categories

---

## Mapbox GL JS Integration

### Map Initialization
**File**: `assets/js/map.js`
**Class**: `ClearMap`
**Creates**: Custom map style with Mapbox raster tiles, adds controls, sets up POI sources

### POI Clustering
Uses Mapbox GL JS built-in clustering with configurable distance and min points

### Layers
- **clusters** - Clustered POI markers
- **cluster-count** - Cluster count labels
- **unclustered-point** - Individual POI markers
- **subway-lines** - NYC subway lines (optional)
- **subway-lines-labels** - Subway line labels

---

## CSS Class Structure

### Map Container
- `.clear-map-container` - Main container
- `.clear-map` - Mapbox map instance

### Filters Panel
- `.clear-map-filters` - Filter sidebar
- `.filters-header` - Header with toggle
- `.filters-content` - Scrollable content
- `.filter-category` - Category row
- `.category-header` - Category name/color
- `.category-pois` - POI list
- `.poi-item` - Individual POI in list

### Tooltips
- `.clear-map-tooltip` - Main tooltip container
- `.tooltip-name` - POI name
- `.tooltip-address` - POI address

---

## Migration Notes

### Plugin Rename
Renamed from "The Andrea Map" to "Clear Map"
**Migration script**: `migrate-data.php` (activated by defining `CLEAR_MAP_MIGRATE` in wp-config.php)
**Changes all option names**: `andrea_map_*` â†’ `clear_map_*`

---

## Git Repository Preparation

### Files to Include
- All plugin files in `/wp-content/plugins/clear-map/`
- README.md (needs to be created)
- LICENSE file (GPL v2 or later)

### Files to Exclude (.gitignore)
- Test KML files (user's specific data)
- Test/debug PHP scripts (`check-*.php`, `test-*.php`)
- `migrate-data.php` (legacy migration script)
- Any client-specific customizations

---

## Developer Notes

### Code Style
- WordPress Coding Standards
- Class names: `Clear_Map_ClassName`
- Function names: `snake_case`
- JavaScript: ES6 classes, jQuery for admin

### Error Logging
- All geocoding operations log to WordPress error log
- Activity log in admin dashboard tracks major actions

### Caching
- Geocoding results cached in WordPress transients (24 hours)
- Cache key format: `clear_map_geocode_mapbox_{md5(address)}` or `clear_map_reverse_geocode_mapbox_{md5(lat,lng)}`

### Performance
- POI limit: 30 per category (configurable in code)
- Activity log: Last 20 actions
- Transient cache: 24 hours for geocoding, 1 hour for import data

---

## Questions to Ask User in Next Session

1. **Tooltip Issue**: Since CSS was updated but not applying, should we:
   - Check if assets are being enqueued with version numbers?
   - Force clear WordPress cache?
   - Check browser cache?
   - Verify CSS file is being loaded?

2. **UI/UX Updates**: What specific admin UI/UX improvements do you want to make?
   - Settings page layout?
   - Import workflow?
   - Dashboard design?
   - Category management?
   - POI management interface?

3. **Git Repository**:
   - Do you want help creating README.md and documentation?
   - Any client-specific files to exclude?
   - Should we remove test/debug files before pushing?

---

## End of Context

**Next Session Goal**: Admin UI/UX updates before GitHub push
**Current Status**: Plugin fully functional, geocoding working, tooltips need investigation
**Ready for**: UI/UX improvements, documentation, Git repository preparation
